#!/usr/bin/env bash
#
# A dynamic scala runner, using coursier's app launch capabilities.
# Author: Dale Wijnand <dale.wijnand@gmail.com>
# https://github.com/dwijnand/scala-runners

app_name=$(basename "$0")

declare -r app_name
declare scala_version=latest.stable
declare -a java_args residual_args
declare verbose

declare -r scala_ea_builds_url=https://scala-ci.typesafe.com/artifactory/scala-integration
declare -r scala_pr_builds_url=https://scala-ci.typesafe.com/artifactory/scala-pr-validation-snapshots

echoerr() { echo >&2 "$@"; }
vlog()    { [[ -n "$verbose" ]] && echoerr "$@"; }

addJava()      {
  vlog "[addJava] arg = '$1'"
  java_args+=("-D")
  java_args+=("${1:2}")
}
addCoursier () {
  vlog "[addCoursier] arg = '$1'"
  coursier_args+=("$1")
}
setScalaVersion() {
  vlog "[setScalaVersion] arg = '$1'"
  scala_version="$1"
  case "$1" in
    *-bin-*SNAPSHOT) addCoursier "-r" && addCoursier "$scala_pr_builds_url" ;;
    *-bin-*)         addCoursier "-r" && addCoursier "$scala_ea_builds_url" ;;
  esac
}

require_arg() {
  local type="$1"
  local opt="$2"
  local arg="$3"

  if [[ -z "$arg" ]] || [[ "${arg:0:1}" == "-" ]]; then
    echo "Aborting: $opt requires <$type> argument"
    exit 1
  fi
}

while [[ $# -gt 0 ]]; do
  case "$1" in
                 -v) verbose=true && shift ;;
    --scala-version) require_arg version "$1" "$2" && setScalaVersion "$2" && shift 2 ;;
                -28) scala_version="2.8+"  && shift ;;
                -29) scala_version="2.9+"  && shift ;;
               -210) scala_version="2.10+" && shift ;;
               -211) scala_version="2.11+" && shift ;;
               -212) scala_version="2.12+" && shift ;;
               -213) scala_version="2.13+" && shift ;;
                -C*) addCoursier "${1:2}"  && shift ;;
                -D*) addJava "$1"          && shift ;;
                  *) residual_args+=("$1") && shift ;;
  esac
done

execRunner() {
  # print the arguments one to a line, quoting any containing spaces
  vlog "# Executing command line:" && {
    for arg; do
      if [[ -n "$arg" ]]; then
        if printf "%s\n" "$arg" | grep -q ' '; then
          printf >&2 "\"%s\"\n" "$arg"
        else
          printf >&2 "%s\n" "$arg"
        fi
      fi
    done
    vlog ""
  }

  "$@"
}

execRunner cs launch \
  "$app_name:$scala_version" \
  "${java_args[@]}" \
  "${coursier_args[@]}" \
  -- "${residual_args[@]}"
